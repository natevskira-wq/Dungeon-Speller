<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Dungeon Speller - Spelling Adventure Game</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Philosopher:wght@400;700&family=Rajdhani:wght@500;700&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">

<style>
    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CSS STYLES & ANIMATIONS
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    
    :root {
        /* Color Palette */
        --bg-primary: #1a1a2e;
        --bg-secondary: rgba(22, 33, 62, 0.85);
        --accent-purple: #8b5cf6;
        --accent-blue: #3b82f6;
        --gold: #fbbf24;
        --gold-glow: rgba(251, 191, 36, 0.5);
        --success: #10b981;
        --danger: #ef4444;
        --text-light: #f8fafc;
        --text-dim: #94a3b8;
        
        /* Fonts */
        --font-title: 'Cinzel', serif;
        --font-body: 'Philosopher', serif;
        --font-ui: 'Rajdhani', sans-serif;
        --font-arabic: 'Noto Sans Arabic', sans-serif;
        
        /* Responsive sizes */
        --mobile-scale: 0.85;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-tap-highlight-color: transparent; /* Better mobile tap feedback */
        -webkit-touch-callout: none; /* Disable callout on mobile */
    }

    /* Allow text selection only for specific elements */
    body, .word-tile, .btn {
        user-select: none;
    }

    input[type="text"] {
        user-select: text;
    }

    body {
        background-color: var(--bg-primary);
        color: var(--text-light);
        font-family: var(--font-body);
        overflow: hidden; /* Prevent scrolling */
        width: 100vw;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        touch-action: manipulation; /* Better touch responsiveness */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    /* --- LAYOUT UTILITIES --- */
    .screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.8s ease;
        z-index: 1;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        overflow: hidden;
    }

    .screen.active {
        opacity: 1;
        pointer-events: all;
        z-index: 10;
    }

    /* --- BACKGROUND VIDEOS --- */
    .bg-video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: -1;
        opacity: 0.6;
    }

    /* Hide video on very small screens to save performance */
    @media (max-width: 240px) {
        .bg-video {
            display: none;
        }
        #gameScreen {
            background: linear-gradient(to bottom, #0f172a, #1a1a2e);
        }
    }

    /* --- TYPOGRAPHY --- */
    h1 {
        font-family: var(--font-title);
        font-size: clamp(2.5rem, 6vw, 4rem);
        color: var(--gold);
        text-shadow: 0 0 15px var(--gold-glow);
        margin-bottom: 1.5rem;
        text-align: center;
        letter-spacing: 1px;
        line-height: 1.2;
    }

    h2 {
        font-family: var(--font-title);
        font-size: clamp(1.8rem, 5vw, 2.5rem);
        color: var(--text-light);
        margin-bottom: 1rem;
    }

    /* --- BUTTONS --- */
    .btn {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        border: 2px solid var(--accent-blue);
        color: white;
        padding: clamp(12px, 4vw, 15px) clamp(25px, 6vw, 35px);
        font-family: var(--font-ui);
        font-size: clamp(1.2rem, 4vw, 1.5rem);
        font-weight: 700;
        text-transform: uppercase;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        margin: 10px;
        min-width: 160px;
        min-height: 50px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }

    .btn:active {
        transform: translateY(1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 0 20px var(--accent-purple);
        border-color: var(--gold);
    }

    .btn:disabled {
        background: #475569;
        border-color: #64748b;
        cursor: not-allowed;
        opacity: 0.7;
        transform: none !important;
    }

    .btn-gold {
        background: linear-gradient(135deg, #d97706 0%, #fbbf24 100%);
        border-color: #fcd34d;
        color: #1a1a2e;
    }

    /* --- MENU SCREEN --- */
    #menuScreen {
        background-image: url('door-closed.png');
        background-color: #0f172a;
    }

    .menu-panel {
        background: var(--bg-secondary);
        padding: clamp(25px, 6vw, 45px);
        border-radius: 16px;
        border: 1px solid var(--accent-blue);
        box-shadow: 0 0 40px rgba(0,0,0,0.5);
        text-align: center;
        backdrop-filter: blur(10px);
        max-width: min(550px, 90vw);
        width: 90%;
        margin: 25px;
    }

    .lang-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 25px;
    }

    .lang-btn {
        background: rgba(255,255,255,0.1);
        border: 1px solid var(--text-dim);
        padding: 15px;
        border-radius: 6px;
        color: var(--text-light);
        cursor: pointer;
        transition: 0.2s;
        min-height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: clamp(1.1rem, 3vw, 1.2rem);
    }

    .lang-btn:active {
        transform: scale(0.98);
    }

    .lang-btn.selected {
        background: var(--accent-purple);
        border-color: var(--gold);
        color: white;
        box-shadow: 0 0 10px var(--accent-purple);
    }

    input[type="text"] {
        width: 100%;
        padding: 18px;
        margin: 25px 0;
        background: rgba(0,0,0,0.3);
        border: 2px solid var(--accent-blue);
        border-radius: 8px;
        color: white;
        font-family: var(--font-ui);
        font-size: clamp(1.2rem, 4vw, 1.4rem);
        text-align: center;
    }

    input[type="text"]:focus {
        outline: none;
        border-color: var(--gold);
        box-shadow: 0 0 15px var(--gold-glow);
    }

    /* --- GAME ARENA --- */
    #gameScreen {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 100vh;
    overflow: hidden;
}

.hud-top {
    flex-shrink: 0;
}

.arena-center {
    flex-grow: 1;
    flex-shrink: 0;
}

.interaction-area {
    flex-shrink: 0;
}


    .hud-top {
        width: 100%;
        padding: 15px clamp(15px, 4vw, 25px);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        z-index: 5;
        flex-wrap: wrap;
        gap: 12px;
    }

    .player-panel, .ghost-panel {
        background: var(--bg-secondary);
        padding: 15px 20px;
        border-radius: 12px;
        border: 1px solid var(--accent-blue);
        min-width: min(220px, 45vw);
        flex: 1;
    }

    .stats-row {
        display: flex;
        justify-content: space-between;
        font-family: var(--font-ui);
        font-weight: 700;
        font-size: clamp(0.6rem, 3vw, 1.3rem);
        margin-bottom: 3px;
    }

    .hp-container {
        width: 100%;
        height: 5px;
        background: #334155;
        border-radius: 6px;
        overflow: hidden;
        position: relative;
        border: 1px solid #475569;
    }

    .hp-bar {
        height: 100%;
        width: 100%;
        background: linear-gradient(90deg, #10b981, #34d399);
        transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1), background 0.6s ease;
    }

    /* Torch Video Overlay */
    .torch-overlay {
        position: absolute;
        top: 10%;
        right: 5%;
        width: min(100px, 20vw);
        height: min(150px, 30vw);
        opacity: 0.8;
        mix-blend-mode: screen;
        pointer-events: none;
        z-index: 2;
    }

    /* Ghost Area */
    .arena-center {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: relative;
        width: 100%;
        padding: 10px;
    }

    .ghost-sprite {
        width: min(380px, 85vw);
        height: min(450px, 95vw);
        background-image: url('ghost-main.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        filter: drop-shadow(0 0 20px rgba(139, 92, 246, 0.4));
        transition: transform 0.5s ease;
        position: relative;
        z-index: 3;
    }

    .hit-effect {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: min(300px, 70vw);
        height: min(300px, 70vw);
        background-image: url('ghost-hit-effect.png');
        background-size: cover;
        display: none;
        z-index: 4;
    }

    .dialogue-box {
        position: absolute;
        top: 60%;
        left: 50%;
        transform: translate(-50%, 0);
        width: min(550px, 90%);
        min-height: 25px;
        background: rgba(0, 0, 0, 0.2);
        border: 0px solid #fbbf24;
        border-radius: 15px;
        box-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20;
        padding: 2px;
    }

    #ghostText {
        margin: 0;
        padding: clamp(10px, 3vw, 18px);
        color: #fbbf24;
        font-family: 'Philosopher', serif;
        font-size: clamp(1.2rem, 4vw, 1.6rem);
        line-height: 1.5;
        text-align: center;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    /* Interaction Area */
    .interaction-area {
        background: linear-gradient(to top, #0f172a 90%, transparent);
        width: 100%;
        padding: clamp(15px, 4vw, 25px);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        z-index: 10;
    }

    .sentence-preview {
        position: absolute;
        top: 70%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 50;
        font-size: clamp(1.5rem, 3vw, 2rem);
        font-family: var(--font-title);
        font-weight: bold;
        text-align: center;
        width: 90%;
        color: #fbbf24;
        text-shadow: 
            0 2px 0 #000, 
            0 0 20px rgba(0,0,0,0.8);
        pointer-events: none;
        transition: opacity 0.5s;
        padding: 0 15px;
    }

    .drop-zone, .word-pool {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        width: 100%;
        max-width: 850px;
        min-height: 70px;
        padding: 15px;
    }

    .drop-zone {
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        border-bottom: 2px solid var(--text-dim);
    }

    .word-tile {
        background: var(--bg-secondary);
        border: 1px solid var(--accent-purple);
        color: white;
        padding: clamp(8px, 3vw, 10px) clamp(15px, 4vw, 20px);
        border-radius: 6px;
        cursor: pointer;
        font-family: var(--font-ui);
        font-size: clamp(1.1rem, 3vw, 1.3rem);
        transition: all 0.2s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        min-height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        touch-action: manipulation;
        -webkit-user-select: none;
        user-select: none;
    }

    .word-tile:active {
        transform: scale(0.95);
        background: var(--accent-purple);
    }

    .word-tile:hover {
        background: var(--accent-purple);
        transform: scale(1.05);
    }

    /* Disabled state for tiles */
    .word-tile.disabled {
        opacity: 0.5;
        pointer-events: none;
        cursor: not-allowed;
    }

    /* --- VICTORY / DEFEAT --- */
    #victoryScreen { 
        background-image: url('victory-bg.png'); 
        background-color: #0f172a;
    }
    #defeatScreen { 
        background-image: url('defeat-bg.png'); 
        background-color: #0f172a;
    }

    .end-panel {
        background: rgba(0,0,0,0.85);
        padding: clamp(25px, 6vw, 45px);
        border-radius: 20px;
        text-align: center;
        border: 2px solid var(--gold);
        box-shadow: 0 0 50px var(--gold-glow);
        max-width: min(650px, 90vw);
        width: 90%;
        margin: 25px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin: 25px 0;
        background: rgba(255,255,255,0.05);
        padding: 20px;
        border-radius: 10px;
    }

    .stat-item h3 { 
        font-size: clamp(1rem, 3vw, 1.2rem);
        color: var(--text-dim); 
        margin-bottom: 8px;
    }
    .stat-item p { 
        font-size: clamp(1.5rem, 4vw, 1.8rem);
        font-weight: bold; 
        color: var(--gold); 
    }

    /* Item image styling */
    .item-image {
        width: 120px;
        height: 120px;
        margin: 15px auto;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        border: 3px solid var(--gold);
        border-radius: 10px;
        box-shadow: 0 0 20px var(--gold-glow);
        background-color: rgba(0, 0, 0, 0.3);
    }

    /* --- RTL SUPPORT --- */
    body.rtl { direction: rtl; font-family: var(--font-arabic); }
    body.rtl h1 { letter-spacing: 0; }
    body.rtl .hud-top { flex-direction: row-reverse; }

    /* --- ANIMATIONS --- */
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-15px); }
    }

    @keyframes damage-flash {
        0% { background-color: var(--danger); }
        100% { background-color: var(--bg-primary); }
    }

    .shake-anim { animation: shake 0.4s ease-in-out; }
    .damage-anim { animation: damage-flash 0.2s; }
    .ghost-idle { animation: float 3s ease-in-out infinite; }

/* --- RESPONSIVE --- */

/* Tablet and smaller devices */
@media (max-width: 768px) {
    .hud-top {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
        padding: 10px 15px;
        flex-shrink: 0;
    }
    
    .player-panel, .ghost-panel {
        min-width: 100%;
        padding: 3px 5px;
        flex-shrink: 0;
    }
    
    .arena-center {
        min-height: 40vh;
        max-height: 40vh;
        padding: 5px;
        justify-content: flex-start;
        margin-top: 10px;
    }
    
    .ghost-sprite {
        width: min(200px, 60vw);
        height: min(250px, 70vw);
        margin-top: 10px;
        flex-shrink: 0;
    }
    
    .dialogue-box {
        top: 40%;
        width: 85%;
        padding: 5px;
        min-height: 20px;
        transform: translate(-50%, -50%);
        position: absolute;
    }
    
    #ghostText {
        font-size: 1rem;
        line-height: 1.2;
        padding: 5px 8px;
    }
    
        .interaction-area {
        padding: 10px 15px;  /* Adjusts vertical padding on mobile */
        min-height: 40vh;    /* Controls minimum height */
        max-height: 50vh;    /* Controls maximum height */
    }
    
    .drop-zone, .word-pool {
        min-height: 50px;    /* Reduced height on mobile */
        max-height: 100px;   /* Limits height to prevent overflow */
    }
}

@media (max-width: 480px) {
    .interaction-area {
        padding: 8px 12px;   /* Even smaller padding on phones */
        min-height: 45vh;    /* Adjusts vertical space allocation */
    }
}

@media (orientation: landscape) and (max-height: 600px) {
    .interaction-area {
        min-height: 35vh;    /* Reduced height in landscape */
        max-height: 40vh;    /* Limits height in landscape */
        padding: 5px 10px;   /* Reduced padding */
    }

    
    .sentence-preview {
        top: 50%;
        font-size: 1.2rem;
        margin-bottom: 10px;
        position: relative;
        transform: translateX(-50%);
    }
    
    .drop-zone, .word-pool {
        min-height: 50px;
        max-height: 100px;
        overflow-y: auto;
        gap: 6px;
        padding: 8px;
    }
    
    .word-tile {
        padding: 8px 12px;
        font-size: 1rem;
        min-height: 40px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .btn {
        min-width: 140px;
        padding: 12px 25px;
        margin: 8px;
    }
    
    .torch-overlay {
        display: none;
    }
    
    .item-image {
        width: 100px;
        height: 100px;
    }
}

/* Small phones */
@media (max-width: 480px) {
    h1 {
        font-size: 2rem;
        margin-bottom: 0.8rem;
    }
    
    .menu-panel {
        padding: 15px;
    }
    
    .lang-btn {
        padding: 10px;
        font-size: 0.9rem;
        min-height: 45px;
    }
    
    .arena-center {
        min-height: 35vh;
        max-height: 35vh;
    }
    
    .ghost-sprite {
        width: 150px;
        height: 180px;
        margin-top: 5px;
    }
    
    .dialogue-box {
        top: 35%;
        width: 90%;
        padding: 4px;
    }
    
    #ghostText {
        font-size: 0.9rem;
        padding: 4px 6px;
    }
    
    .interaction-area {
        padding: 8px 12px;
        min-height: 45vh;
        gap: 8px;
    }
    
    .sentence-preview {
        font-size: 1.1rem;
        margin-bottom: 8px;
    }
    
    .drop-zone, .word-pool {
        min-height: 40px;
        max-height: 80px;
        gap: 4px;
        padding: 6px;
    }
    
    .word-tile {
        padding: 6px 10px;
        font-size: 0.9rem;
        min-height: 35px;
    }
    
    .btn {
        min-width: 120px;
        padding: 10px 20px;
        font-size: 1rem;
        margin: 6px;
    }
    
    .item-image {
        width: 80px;
        height: 80px;
    }
}

/* Landscape mode on mobile */
@media (orientation: landscape) and (max-height: 600px) {
    .hud-top {
        padding: 5px 10px;
        flex-direction: row;
        gap: 5px;
    }
    
    .arena-center {
        min-height: 30vh;
        max-height: 30vh;
        padding: 0;
        margin-top: 0;
    }
    
    .ghost-sprite {
        width: 120px;
        height: 140px;
        margin-top: 0;
    }
    
    .dialogue-box {
        top: 25%;
        width: 80%;
        padding: 3px;
    }
    
    .interaction-area {
        min-height: 35vh;
        max-height: 40vh;
        padding: 5px 10px;
        gap: 5px;
    }
    
    .sentence-preview {
        top: 40%;
        font-size: 1rem;
        margin-bottom: 5px;
    }
    
    .drop-zone, .word-pool {
        min-height: 35px;
        max-height: 60px;
        gap: 3px;
        padding: 4px;
    }
    
    .word-tile {
        padding: 5px 8px;
        font-size: 0.8rem;
        min-height: 30px;
    }
    
    #ghostText {
        font-size: 0.8rem;
        padding: 3px 5px;
    }
}
    /* Prevent text size adjustment on iOS */
    @media screen and (max-device-width: 480px) {
        body {
            -webkit-text-size-adjust: 100%;
        }
    }

    /* Loader */
    .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid var(--accent-purple);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 25px;
    }
    
    @keyframes spin { 
        0% { transform: rotate(0deg); } 
        100% { transform: rotate(360deg); } 
    }
</style>
</head>
<body>

<!-- SCREEN 1: MENU -->
<div id="menuScreen" class="screen">
    <video class="bg-video" src="door-opening.mp4" autoplay muted loop playsinline preload="metadata"></video>
    
    <div class="menu-panel">
        <h1 id="menuTitle">Dungeon Speller</h1>
        
        <div class="lang-grid">
            <div class="lang-btn selected" data-lang="en">üåç English</div>
            
            <div class="lang-btn" data-lang="fr">üåç Fran√ßais</div>
            <div class="lang-btn" data-lang="de">üåç Deutsch</div>
        </div>

        <label for="playerName" id="nameLabel" style="color:var(--text-dim);">Enter Your Name:</label>
        <input type="text" id="playerName" maxlength="20" placeholder="Hero Name..." autocomplete="off" autocorrect="off" autocapitalize="words">
        
        <button id="enterBtn" class="btn btn-gold" disabled>ENTER DUNGEON</button>
    </div>
</div>

<!-- SCREEN 2: GAME ARENA -->
<div id="gameScreen" class="screen">
    <video class="bg-video" src="dungeon-ambient.mp4" autoplay muted loop playsinline preload="metadata"></video>
    <!-- Torch Video Loop -->
    <video class="torch-overlay" src="torch-fire.mp4" autoplay muted loop playsinline preload="metadata"></video>

    <div class="hud-top">
        <div class="player-panel">
            <div class="stats-row">
                <span id="uiPlayerName">Hero</span>
                <span id="uiXP">‚≠ê 0</span>
            </div>
            <div class="hp-container">
                <div id="playerHPBar" class="hp-bar"></div>
            </div>
            <div class="stats-row" style="margin-top:8px; font-size:1.1rem; color:var(--text-dim);">
                <span id="uiStreak">Streak: üî• 0</span>
            </div>
        </div>

        <div class="ghost-panel" style="text-align:right;">
            <div class="stats-row" style="justify-content: flex-end;">
                <span>Specter</span>
            </div>
            <div class="hp-container">
                <div id="ghostHPBar" class="hp-bar" style="background: linear-gradient(90deg, #ef4444, #b91c1c);"></div>
            </div>
        </div>
    </div>

    <div class="arena-center">
        <div id="ghostChar" class="ghost-sprite ghost-idle"></div>
        <div id="hitEffect" class="hit-effect"></div>
        <div class="dialogue-box">
            <p id="ghostText">...</p>
        </div>
    </div>

    <div class="interaction-area">
        <div id="sentencePreview" class="sentence-preview"></div>
        
        <!-- Drop Zone (Answer) -->
        <div id="dropZone" class="drop-zone"></div>
        
        <!-- Word Pool (Scrambled) -->
        <div id="wordPool" class="word-pool"></div>
        
        <button id="submitBtn" class="btn">CAST SPELL</button>
    </div>
</div>

<!-- SCREEN 3: VICTORY -->
<div id="victoryScreen" class="screen">
    <div class="end-panel">
        <h1 id="vicTitle">VICTORY!</h1>
        <p id="vicMessage" style="font-size:1.4rem; margin-bottom:25px;">The dungeon is cleansed!</p>
        
        <div class="stats-grid">
            <div class="stat-item">
                <h3 id="vicQLabel">Questions</h3>
                <p id="vicQValue">10/10</p>
            </div>
            <div class="stat-item">
                <h3 id="vicXPLabel">XP Earned</h3>
                <p id="vicXPValue">150</p>
            </div>
            <div class="stat-item">
                <h3 id="vicStrLabel">Best Streak</h3>
                <p id="vicStrValue">10</p>
            </div>
        </div>

        <p id="itemLabel" style="color:var(--gold); margin-bottom:15px; font-size:1.2rem;">Item Acquired:</p>
        <div class="item-image" style="background-image: url('Composition Quill.png');"></div>
        <p style="color:white; margin-bottom:25px; font-size:1.3rem;">Composition Quill ‚úçÔ∏è</p>
        <button class="btn" style="background:#25D366; border-color:#128C7E;" onclick="gameController.shareToWhatsApp(event)">
            üì± Save & Share
        </button>
        <button class="btn btn-gold" onclick="gameController.restartGame()">Play Again</button>
        <button class="btn" onclick="uiController.showScreen('menuScreen')">Main Menu</button>
    </div>
</div>

<!-- SCREEN 4: DEFEAT -->
<div id="defeatScreen" class="screen">
    <div class="end-panel" style="border-color: var(--danger);">
        <h1 id="defTitle" style="color: var(--danger);">DEFEATED</h1>
        <p id="defMessage">The specter was too strong...</p>
        
        <div class="stats-grid">
            <div class="stat-item"><h3>Questions</h3><p id="defQValue">5/10</p></div>
            <div class="stat-item"><h3>XP Earned</h3><p id="defXPValue">50</p></div>
            <div class="stat-item"><h3>Best Streak</h3><p id="defStrValue">3</p></div>
        </div>
        
        <button class="btn btn-gold" onclick="gameController.restartGame()">Try Again</button>
        <button class="btn" onclick="uiController.showScreen('menuScreen')">Main Menu</button>
    </div>
</div>

<!-- LOADING OVERLAY -->
<div id="loadingScreen" class="screen active" style="background:#000; z-index:100;">
    <div class="loader"></div>
    <p style="color:var(--text-dim); margin-top:15px; text-align:center; padding:0 25px;">Loading Dungeon Speller...</p>
    <p id="loadingProgress" style="color:var(--text-dim); margin-top:8px; font-size:1.1rem;">Initializing...</p>
</div>

<!-- DUNGEON SPELLER CERTIFICATE (HIDDEN) -->
<div id="certificateNode"
    style="
        position:fixed;
        left:-9999px;
        top:-9999px;
        width:900px;
        height:650px;
        padding:40px;
        background:#f5e6c8;
        border:16px double #3a1f1f;
        border-radius:25px;
        box-shadow:0 0 35px rgba(0,0,0,0.55);
        text-align:center;
        font-family:'Georgia', serif;
        color:#3a2415;
        z-index:9999;
        background-image:
            radial-gradient(circle at 50% 50%, #fff7e2, #eed5a3);
    ">

    <!-- üîÆ Ornamental Corners -->
    <div style="position:absolute; top:18px; left:18px; font-size:36px; color:#6b3f76;">‚ù¶</div>
    <div style="position:absolute; top:18px; right:18px; font-size:36px; color:#6b3f76;">‚ùß</div>
    <div style="position:absolute; bottom:18px; left:18px; font-size:36px; color:#6b3f76;">‚ùß</div>
    <div style="position:absolute; bottom:18px; right:18px; font-size:36px; color:#6b3f76;">‚ù¶</div>

    <!-- Decorative Upper Strip -->
    <div style="
        width:100%;
        height:12px;
        background:#c69d57;
        border-bottom:3px solid #4a2a2a;
        margin-bottom:20px;
    "></div>

    <!-- üîÆ Header Icons -->
    <div style="
        display:flex;
        justify-content:center;
        align-items:center;
        gap:45px;
        font-size:62px;
        margin-top:0px;
        margin-bottom:-10px;
    ">
        <div>üëª</div>
        <div>üìò‚ú®</div>
        <div>üíÄü™Ω</div>
        <div>üß™</div>
    </div>

    <!-- TITLE -->
    <h1 style="
        font-size:56px;
        margin-top:0px;
        letter-spacing:5px;
        text-shadow:0 2px 4px rgba(0,0,0,0.4);
        color:#3e1f1f;
    ">DUNGEON SPELLER</h1>

    <h2 style="
        font-size:28px;
        letter-spacing:4px;
        margin-top:-5px;
        color:#5a3a19;
    ">ARCANE ACHIEVEMENT SCROLL</h2>

    <!-- Lore Text -->
    <p style="
        width:75%;
        margin:auto;
        margin-top:15px;
        font-size:20px;
        color:#5a3a19;
        line-height:1.4;
    ">
        This enchanted scroll certifies that the spellcaster below has  
        skillfully arranged the sacred words and defeated the dreaded  
        <b>Spelling Specter</b> within the Dungeon of Lost Sentences.
    </p>

    <!-- ‚ú® NAME ‚Äì Centered -->
    <div style="margin-top:30px;">
        <div style="font-size:20px; letter-spacing:3px;">SPELLCASTER NAME</div>
        <div id="certName"
            style="
                font-size:44px;
                font-weight:bold;
                padding:15px 0;
                width:60%;
                margin:auto;
                border-bottom:4px solid #7a4f2f;
                color:#3e1f1f;
            ">
            Mage Name
        </div>
    </div>

    <!-- ‚ú® XP + STREAK SIDE BY SIDE -->
    <div style="
        margin-top:20px;
        display:flex;
        justify-content:center;
        gap:120px;
        text-align:center;
    ">
        <!-- XP -->
        <div>
            <div style="font-size:20px; letter-spacing:3px;">XP</div>
            <div id="certXP"
                style="
                    font-size:40px;
                    font-weight:bold;
                    padding:5px 0;
                    width:150px;
                    margin:auto;
                    border-bottom:4px solid #7a4f2f;
                ">
                150
            </div>
        </div>

        <!-- STREAK -->
        <div>
            <div style="font-size:20px; letter-spacing:3px;">STREAK</div>
            <div id="certStreak"
                style="
                    font-size:40px;
                    font-weight:bold;
                    padding:5px 0;
                    width:150px;
                    margin:auto;
                    border-bottom:4px solid #7a4f2f;
                ">
                12
            </div>
        </div>
    </div>

    <!-- üßô Bottom Icons -->
    <div style="
        margin-top:50px;
        display:flex;
        justify-content:center;
        gap:70px;
        font-size:60px;
        color:#3e1f1f;
    ">
        <div>ü™Ñ</div>
        <div>üêâ</div>
        <div>üïØÔ∏è</div>
        <div>üìú</div>
        <div>üß≠</div>
    </div>

    <!-- Decorative Lower Strip -->
    <div style="
        width:100%;
        height:12px;
        background:#c69d57;
        border-top:3px solid #4a2a2a;
        margin-top:25px;
    "></div>

</div>


<script>
    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       PART 2: DATA & CONFIGURATION
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

const SUPABASE_URL = "https://syrhuxxryctrzjdzexnx.supabase.co";
const SUPABASE_KEY = "sb_publishable_f26IxnkhOy0ckfJ7hFHCrA_NcSnN0Al";

// Initialize Client
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const CONFIG = {
        PLAYER_MAX_HP: 100,
        GHOST_MAX_HP: 100,
        DAMAGE_PLAYER: 30,
        DAMAGE_GHOST: 10,
        XP_PER_WIN: 5,
        ASSETS: {
            audio: [
                'button-click.mp3',
                'correct-answer.mp3',
                'defeat.mp3',
                'victory.mp3',
                'dungeon-ambient.mp3',
                'fire-crackle.mp3',
                'ghost-appear.mp3',
                'ghost-hit.mp3',
                'player-hit.mp3',
                'wrong-answer.mp3'
            ],
            images: ['door-closed.png', 'dungeon-corridor.png', 'ghost-main.png']
        }
    };

    const TRANSLATIONS = {
        en: {
            title: "Dungeon Speller",
            enterName: "Enter Your Name:",
            enterButton: "Enter Dungeon",
            submitAnswer: "CAST SPELL",
            victoryTitle: "VICTORY!",
            defeatTitle: "DEFEATED",
            labels: { q: "Questions", xp: "XP Earned", str: "Best Streak", item: "Item Found:" },
            msg: { 
                win: "You have bested the Spelling Specter!", 
                loss: "The Specter's words proved too powerful..." 
            },
            ghost: [
                "You dare enter my domain?",
                "Arrange my words or face doom!",
                "Foolish mortal, can you handle this?",
                "Your streak means nothing to me!"
            ]
        },
        ar: {
            title: "ÿ™Ÿáÿ¨ÿ¶ÿ© ÿßŸÑÿ≤ŸÜÿ≤ÿßŸÜÿ©",
            enterName: "ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ:",
            enterButton: "ÿßÿØÿÆŸÑ ÿßŸÑÿ≤ŸÜÿ≤ÿßŸÜÿ©",
            submitAnswer: "ÿ•ŸÑŸÇÿßÿ° ÿßŸÑÿ™ÿπŸàŸäÿ∞ÿ©",
            victoryTitle: "ŸÜÿµÿ±!",
            defeatTitle: "Ÿáÿ≤ŸäŸÖÿ©",
            labels: { q: "ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©", xp: "ÿßŸÑÿÆÿ®ÿ±ÿ©", str: "ÿ£ŸÅÿ∂ŸÑ ÿ™ÿ™ÿßÿ®ÿπ", item: "ÿπŸÜÿµÿ±:" },
            msg: { 
                win: "ŸÑŸÇÿØ Ÿáÿ≤ŸÖÿ™ ÿ¥ÿ®ÿ≠ ÿßŸÑÿ™Ÿáÿ¨ÿ¶ÿ©!", 
                loss: "ŸÉÿßŸÜÿ™ ŸÉŸÑŸÖÿßÿ™ ÿßŸÑÿ¥ÿ®ÿ≠ ŸÇŸàŸäÿ© ÿ¨ÿØÿßŸã..." 
            },
            ghost: [
                "ŸáŸÑ ÿ™ÿ¨ÿ±ÿ§ ÿπŸÑŸâ ÿØÿÆŸàŸÑ ŸÖŸÖŸÑŸÉÿ™Ÿäÿü",
                "ÿ±ÿ™ÿ® ŸÉŸÑŸÖÿßÿ™Ÿä ÿ£Ÿà Ÿàÿßÿ¨Ÿá ÿßŸÑŸáŸÑÿßŸÉ!",
                "ÿ£ŸäŸáÿß ÿßŸÑŸÅÿßŸÜŸä ÿßŸÑÿ£ÿ≠ŸÖŸÇÿå ŸáŸÑ ÿ™ÿ≥ÿ™ÿ∑Ÿäÿπ ÿ™ÿ≠ŸÖŸÑ Ÿáÿ∞ÿßÿü",
                "ÿ≥ŸÑÿ≥ŸÑÿ™ŸÉ ŸÑÿß ÿ™ÿπŸÜŸä ŸÑŸä ÿ¥Ÿäÿ¶ÿßŸã!"
            ]
        },
        fr: {
            title: "Le Donjon des Mots",
            enterName: "Entrez votre nom:",
            enterButton: "Entrer dans le donjon",
            submitAnswer: "Lancer le sort",
            victoryTitle: "VICTOIRE !",
            defeatTitle: "D√âFAITE",
            labels: { q: "Questions", xp: "XP Gagn√©", str: "Meilleure S√©rie", item: "Item:" },
            msg: { win: "Vous avez vaincu le Spectre !", loss: "Les mots du Spectre √©taient trop puissants..." },
            ghost: ["Oses-tu entrer dans mon domaine ?", "Arrange mes mots ou fais face au destin !"]
        },
        de: {
            title: "Wort-Kerker",
            enterName: "Gib deinen Namen ein:",
            enterButton: "Betrete den Kerker",
            submitAnswer: "Zauber wirken",
            victoryTitle: "SIEG!",
            defeatTitle: "NIEDERLAGE",
            labels: { q: "Fragen", xp: "EP Verdient", str: "Beste Serie", item: "Gegenstand:" },
            msg: { win: "Du hast das Gespenst besiegt!", loss: "Die Worte des Gespensts waren zu m√§chtig..." },
            ghost: ["Wagst du es, mein Reich zu betreten?", "Ordne meine Worte oder stirb!"]
        }
    };

    const QUESTIONS_DB = {
        en: [
            "Everyone admired the huge proud ship",
            "It sailed across the deep blue ocean",
            "I was just a little digger",
            "The digger stayed on the sandy shore",
            "I was always ready to help others",
            "The ship came close to load cargo",
            "Suddenly something went wrong near the shore",
            "The ship got stuck in heavy mud",
            "The thick mud held the ship fast",
            "The ship tried hard to move away",
            "Big machines rushed to help the ship",
            "None of them could pull it out",
            "Everyone started to give up hope",
            "I said that I could help them",
            "The big machines laughed at me",
            "I started digging carefully around the ship",
            "I worked hard to clear the mud",
            "Finally the path was clear again",
            "The huge ship floated free at last",
            "Size does not matter for inner strength"
        ],
        ar: [
            "ÿ£ÿπÿ¨ÿ® ÿßŸÑÿ¨ŸÖŸäÿπ ÿ®ÿßŸÑÿ≥ŸÅŸäŸÜÿ© ÿßŸÑÿ∂ÿÆŸÖÿ© ÿßŸÑŸÅÿÆŸàÿ±ÿ©",
            "ÿ£ÿ®ÿ≠ÿ±ÿ™ ÿπÿ®ÿ± ÿßŸÑŸÖÿ≠Ÿäÿ∑ ÿßŸÑÿ£ÿ≤ÿ±ŸÇ ÿßŸÑÿπŸÖŸäŸÇ",
            "ŸÉŸÜÿ™ ŸÖÿ¨ÿ±ÿØ ÿ≠ŸÅÿßÿ± ÿµÿ∫Ÿäÿ±",
            "ÿ®ŸÇŸä ÿßŸÑÿ≠ŸÅÿßÿ± ÿπŸÑŸâ ÿßŸÑÿ¥ÿßÿ∑ÿ¶ ÿßŸÑÿ±ŸÖŸÑŸä",
            "ŸÉŸÜÿ™ ÿØÿßÿ¶ŸÖÿßŸã ŸÖÿ≥ÿ™ÿπÿØÿßŸã ŸÑŸÖÿ≥ÿßÿπÿØÿ© ÿßŸÑÿ¢ÿÆÿ±ŸäŸÜ",
            "ÿßŸÇÿ™ÿ±ÿ®ÿ™ ÿßŸÑÿ≥ŸÅŸäŸÜÿ© ŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ÿ∂ÿßÿ¶ÿπ",
            "ŸÅÿ¨ÿ£ÿ© ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÖÿß ŸÇÿ±ÿ® ÿßŸÑÿ¥ÿßÿ∑ÿ¶",
            "ÿπŸÑŸÇÿ™ ÿßŸÑÿ≥ŸÅŸäŸÜÿ© ŸÅŸä ÿßŸÑŸàÿ≠ŸÑ ÿßŸÑÿ´ŸÇŸäŸÑ",
            "ÿ£ŸÖÿ≥ŸÉ ÿßŸÑÿ∑ŸäŸÜ ÿßŸÑÿ≥ŸÖŸäŸÉ ÿ®ÿßŸÑÿ≥ŸÅŸäŸÜÿ© ÿ®ŸÇŸàÿ©",
            "ÿ≠ÿßŸàŸÑÿ™ ÿßŸÑÿ≥ŸÅŸäŸÜÿ© ÿ¨ÿßŸáÿØÿ© ÿ£ŸÜ ÿ™ÿ™ÿ≠ÿ±ŸÉ",
            "ÿßŸÜÿØŸÅÿπÿ™ ÿßŸÑÿ¢ŸÑÿßÿ™ ÿßŸÑŸÉÿ®Ÿäÿ±ÿ© ŸÑŸÖÿ≥ÿßÿπÿØÿ© ÿßŸÑÿ≥ŸÅŸäŸÜÿ©",
            "ŸÑŸÖ Ÿäÿ≥ÿ™ÿ∑ÿπ ÿ£Ÿä ŸÖŸÜŸáŸÖ ÿ≥ÿ≠ÿ®Ÿáÿß ŸÑŸÑÿÆÿßÿ±ÿ¨",
            "ÿ®ÿØÿ£ ÿßŸÑÿ¨ŸÖŸäÿπ ŸäŸÅŸÇÿØŸàŸÜ ÿßŸÑÿ£ŸÖŸÑ",
            "ŸÇŸÑÿ™ ÿ£ŸÜŸÜŸä ÿ£ÿ≥ÿ™ÿ∑Ÿäÿπ ŸÖÿ≥ÿßÿπÿØÿ™ŸáŸÖ",
            "ÿ∂ÿ≠ŸÉÿ™ ÿßŸÑÿ¢ŸÑÿßÿ™ ÿßŸÑŸÉÿ®Ÿäÿ±ÿ© ÿπŸÑŸä",
            "ÿ®ÿØÿ£ÿ™ ÿßŸÑÿ≠ŸÅÿ± ÿ®ÿπŸÜÿßŸäÿ© ÿ≠ŸàŸÑ ÿßŸÑÿ≥ŸÅŸäŸÜÿ©",
            "ÿπŸÖŸÑÿ™ ÿ®ÿ¨ÿØ ŸÑÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ∑ŸäŸÜ",
            "ÿ£ÿÆŸäÿ±ÿßŸã ÿ£ÿµÿ®ÿ≠ ÿßŸÑÿ∑ÿ±ŸäŸÇ Ÿàÿßÿ∂ÿ≠ÿßŸã ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ",
            "ÿ∑ŸÅÿ™ ÿßŸÑÿ≥ŸÅŸäŸÜÿ© ÿßŸÑÿ∂ÿÆŸÖÿ© ÿ≠ÿ±ÿ© ÿ£ÿÆŸäÿ±ÿßŸã",
            "ÿßŸÑÿ≠ÿ¨ŸÖ ŸÑÿß ŸäŸáŸÖ ŸÑŸÑŸÇŸàÿ© ÿßŸÑÿØÿßÿÆŸÑŸäÿ©"
        ],
        fr: [
            "Tout le monde admirait l'immense navire fier",
            "Il naviguait √† travers l'oc√©an bleu profond",
            "J'√©tais juste une petite pelleteuse",
            "La pelleteuse restait sur le rivage sablonneux",
            "J'√©tais toujours pr√™t √† aider les autres",
            "Le navire s'est approch√© pour charger la cargaison",
            "Soudain quelque chose a mal tourn√© pr√®s du rivage",
            "Le navire s'est coinc√© dans la boue lourde",
            "La boue √©paisse retenait le navire fermement",
            "Le navire a essay√© fort de bouger",
            "De grosses machines se sont pr√©cipit√©es pour aider",
            "Aucune d'elles ne pouvait le sortir",
            "Tout le monde a commenc√© √† perdre espoir",
            "J'ai dit que je pouvais les aider",
            "Les grosses machines se moquaient de moi",
            "J'ai commenc√© √† creuser soigneusement autour du navire",
            "J'ai travaill√© dur pour d√©gager la boue",
            "Finalement le chemin √©tait clair √† nouveau",
            "L'immense navire a flott√© libre enfin",
            "La taille ne compte pas pour la force int√©rieure"
        ],
        de: [
            "Jeder bewunderte das riesige stolze Schiff",
            "Es segelte √ºber den tiefblauen Ozean",
            "Ich war nur ein kleiner Bagger",
            "Der Bagger blieb am sandigen Ufer",
            "Ich war immer bereit anderen zu helfen",
            "Das Schiff kam nah um Fracht zu laden",
            "Pl√∂tzlich ging etwas schief nahe dem Ufer",
            "Das Schiff blieb im schweren Schlamm stecken",
            "Der dicke Schlamm hielt das Schiff fest",
            "Das Schiff versuchte hart sich zu bewegen",
            "Gro√üe Maschinen eilten um dem Schiff zu helfen",
            "Keine von ihnen konnte es herausziehen",
            "Alle fingen an die Hoffnung aufzugeben",
            "Ich sagte dass ich ihnen helfen k√∂nnte",
            "Die gro√üen Maschinen lachten √ºber mich",
            "Ich fing an vorsichtig um das Schiff zu graben",
            "Ich arbeitete hart um den Schlamm zu entfernen",
            "Endlich war der Weg wieder frei",
            "Das riesige Schiff schwamm endlich frei",
            "Gr√∂√üe ist nicht wichtig f√ºr innere St√§rke"
        ]
    };
    
    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       PART 3: GAME LOGIC
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    // --- 1. STATE MANAGEMENT ---
    const gameState = {
        lang: 'en',
        name: '',
        playerHP: CONFIG.PLAYER_MAX_HP,
        ghostHP: CONFIG.GHOST_MAX_HP,
        xp: 0,
        streak: 0,
        highStreak: 0,
        questionsAnswered: 0,
        currentQ: null,
        isGameActive: false
    };

    // --- 2. AUDIO MANAGER ---
    class AudioManager {
        constructor() {
            this.sounds = {};
            this.bgm = null;
            this.fireSound = null;
            this.isMuted = false;
            this.hasAudioContext = false;
            this.audioContext = null;
            this.init();
        }

        init() {
            this.hasAudioContext = !!(window.AudioContext || window.webkitAudioContext);
            
            if (!this.hasAudioContext) {
                console.warn("AudioContext not supported - using fallback audio");
            }
            
            // Load audio files
            this.loadAudioFiles();
            
            // Initialize audio context on first user interaction
            this.setupAudioContext();
        }

        loadAudioFiles() {
            CONFIG.ASSETS.audio.forEach(file => {
                try {
                    const audio = new Audio();
                    audio.src = file;
                    audio.preload = 'auto';
                    audio.load();
                    this.sounds[file] = audio;
                } catch (e) {
                    console.warn(`Failed to load audio: ${file}`, e);
                }
            });
        }

        setupAudioContext() {
            if (!this.hasAudioContext) return;
            
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.audioContext = new AudioContext();
                
                // Resume audio context on user interaction
                const resumeAudio = () => {
                    if (this.audioContext && this.audioContext.state === 'suspended') {
                        this.audioContext.resume().then(() => {
                            console.log("AudioContext resumed");
                        });
                    }
                };
                
                // Add event listeners for all user interactions
                const events = ['click', 'touchstart', 'keydown', 'mousedown'];
                events.forEach(event => {
                    document.addEventListener(event, resumeAudio, { once: true });
                });
                
            } catch (e) {
                console.warn("Failed to create AudioContext:", e);
                this.hasAudioContext = false;
            }
        }

        play(filename, loop = false, volume = 1.0) {
            if (this.isMuted) return;
            
            try {
                const sound = this.sounds[filename];
                if (!sound) {
                    console.warn(`Audio file not found: ${filename}`);
                    this.playFallbackSound(filename, volume);
                    return;
                }
                
                sound.currentTime = 0;
                sound.loop = loop;
                sound.volume = Math.min(volume, 1.0);
                
                const playPromise = sound.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(e => {
                        console.warn(`Audio play blocked for ${filename}:`, e.message);
                        // Retry on next user interaction
                        const retryPlay = () => {
                            sound.play().catch(e2 => console.warn("Retry also failed:", e2));
                            document.removeEventListener('click', retryPlay);
                            document.removeEventListener('touchstart', retryPlay);
                        };
                        document.addEventListener('click', retryPlay);
                        document.addEventListener('touchstart', retryPlay);
                    });
                }
                
                if (loop) {
                    if (filename === 'dungeon-ambient.mp3') {
                        this.bgm = sound;
                    } else if (filename === 'fire-crackle.mp3') {
                        this.fireSound = sound;
                    }
                }
                
            } catch (e) {
                console.warn(`Error playing ${filename}:`, e);
                this.playFallbackSound(filename, volume);
            }
        }

        playFallbackSound(filename, volume) {
            if (!this.hasAudioContext || !this.audioContext) {
                console.log("Fallback sound for:", filename);
                return;
            }
            
            try {
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                let frequency = 600;
                let duration = 200;
                
                if (filename.includes('correct')) {
                    frequency = 800;
                    duration = 300;
                } else if (filename.includes('wrong')) {
                    frequency = 400;
                    duration = 400;
                } else if (filename.includes('hit')) {
                    frequency = 300;
                    duration = 150;
                } else if (filename.includes('victory')) {
                    frequency = 1000;
                    duration = 1000;
                } else if (filename.includes('defeat')) {
                    frequency = 200;
                    duration = 800;
                } else if (filename.includes('button')) {
                    frequency = 500;
                    duration = 100;
                } else if (filename.includes('ghost')) {
                    frequency = 700;
                    duration = 250;
                }
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                gainNode.gain.value = volume * 0.1;
                
                oscillator.start();
                setTimeout(() => {
                    oscillator.stop();
                }, duration);
                
            } catch (e) {
                console.log("Simple fallback for:", filename);
            }
        }

        stopBGM() {
            if (this.bgm) {
                this.bgm.pause();
                this.bgm.currentTime = 0;
                this.bgm = null;
            }
            if (this.fireSound) {
                this.fireSound.pause();
                this.fireSound.currentTime = 0;
                this.fireSound = null;
            }
        }
        
        enableAudio() {
            if (this.hasAudioContext && this.audioContext && this.audioContext.state === 'suspended') {
                this.audioContext.resume();
            }
        }
    }

    // Initialize audio manager
    const audio = new AudioManager();

    // --- 3. UI CONTROLLER ---
    class UIController {
        constructor() {
            this.screens = document.querySelectorAll('.screen');
            this.hpBarPlayer = document.getElementById('playerHPBar');
            this.hpBarGhost = document.getElementById('ghostHPBar');
            this.dialogue = document.getElementById('ghostText');
            this.submitBtn = document.getElementById('submitBtn');
            this.dropZone = document.getElementById('dropZone');
            this.wordPool = document.getElementById('wordPool');
            this.hitEffect = document.getElementById('hitEffect');
            this.isMobile = this.detectMobile();
        }
        
        detectMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        showScreen(id) {
            this.screens.forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            window.scrollTo(0, 0);
        }

        updateHUD() {
            this.hpBarPlayer.style.width = `${gameState.playerHP}%`;
            this.hpBarGhost.style.width = `${gameState.ghostHP}%`;
            
            if(gameState.playerHP < 30) this.hpBarPlayer.style.backgroundColor = '#ef4444';
            else this.hpBarPlayer.style.backgroundColor = '#10b981';

            document.getElementById('uiPlayerName').textContent = gameState.name;
            document.getElementById('uiXP').textContent = `‚≠ê ${gameState.xp}`;
            document.getElementById('uiStreak').textContent = `Streak: üî• ${gameState.streak}`;
        }

        shakeScreen() {
            document.body.classList.add('shake-anim');
            setTimeout(() => document.body.classList.remove('shake-anim'), 400);
        }

        flashDamage() {
            document.body.classList.add('damage-anim');
            setTimeout(() => document.body.classList.remove('damage-anim'), 200);
        }

        showHitEffect() {
            this.hitEffect.style.display = 'block';
            setTimeout(() => this.hitEffect.style.display = 'none', 300);
        }

        typewriter(text, element) {
            element.textContent = '';
            let i = 0;
            const speed = this.isMobile ? 40 : 30;
            
            function type() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                }
            }
            type();
        }

        updateTranslations(lang) {
            const t = TRANSLATIONS[lang];
            document.getElementById('menuTitle').textContent = t.title;
            document.getElementById('nameLabel').textContent = t.enterName;
            document.getElementById('enterBtn').textContent = t.enterButton;
            document.getElementById('submitBtn').textContent = t.submitAnswer;
            
            document.getElementById('vicTitle').textContent = t.victoryTitle;
            document.getElementById('defTitle').textContent = t.defeatTitle;
            document.getElementById('vicQLabel').textContent = t.labels.q;
            document.getElementById('vicXPLabel').textContent = t.labels.xp;
            document.getElementById('vicStrLabel').textContent = t.labels.str;
            
            if (lang === 'ar') document.body.classList.add('rtl');
            else document.body.classList.remove('rtl');
        }
        
        updateLoadingProgress(message) {
            const progressEl = document.getElementById('loadingProgress');
            if (progressEl) {
                progressEl.textContent = message;
            }
        }
    }

    const uiController = new UIController();

    // --- 4. GAME CONTROLLER ---
    class GameController {
        constructor() {
            this.isQuestionActive = false;
            this.initListeners();
        }

        initListeners() {
            // Language Selection
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('selected'));
                    e.target.classList.add('selected');
                    gameState.lang = e.target.dataset.lang;
                    uiController.updateTranslations(gameState.lang);
                    
                    audio.enableAudio();
                    audio.play('button-click.mp3');
                });
                
                btn.addEventListener('touchstart', () => {
                    btn.style.transform = 'scale(0.98)';
                });
                
                btn.addEventListener('touchend', () => {
                    btn.style.transform = '';
                });
            });

            // Name Input
            const nameInput = document.getElementById('playerName');
            const enterBtn = document.getElementById('enterBtn');
            
            nameInput.addEventListener('input', (e) => {
                gameState.name = e.target.value.trim();
                enterBtn.disabled = gameState.name.length < 2;
            });
            
            nameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !enterBtn.disabled) {
                    this.startGame();
                }
            });

            // Enter Game
            enterBtn.addEventListener('click', () => this.startGame());
            
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('touchstart', () => {
                    btn.style.transform = 'translateY(1px)';
                });
                
                btn.addEventListener('touchend', () => {
                    btn.style.transform = '';
                });
            });

            document.getElementById('submitBtn').addEventListener('click', () => this.checkAnswer());
            
            this.initializeGame();
        }
        
        initializeGame() {
            uiController.updateLoadingProgress("Loading game assets...");
            
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isAndroid = /Android/.test(navigator.userAgent);
            
            if (isIOS) {
                document.body.style.webkitOverflowScrolling = 'touch';
            }
            
            setTimeout(() => {
                uiController.updateLoadingProgress("Initializing game engine...");
                
                setTimeout(() => {
                    uiController.updateLoadingProgress("Ready to play!");
                    
                    setTimeout(() => {
                        console.log("Game initialized successfully");
                        document.getElementById('loadingScreen').classList.remove('active');
                        uiController.showScreen('menuScreen');
                        
                        document.addEventListener('click', () => {
                            audio.enableAudio();
                        }, { once: true });
                        
                    }, 500);
                }, 800);
            }, 500);
        }

        startGame() {
            audio.enableAudio();
            
            gameState.playerHP = CONFIG.PLAYER_MAX_HP;
            gameState.ghostHP = CONFIG.GHOST_MAX_HP;
            gameState.xp = 0;
            gameState.streak = 0;
            gameState.highStreak = 0;
            gameState.questionsAnswered = 0;
            gameState.isGameActive = true;
            this.isQuestionActive = false;

            this.questionPool = [...QUESTIONS_DB[gameState.lang]];

            audio.play('button-click.mp3');
            audio.play('dungeon-ambient.mp3', true, 0.3);
            audio.play('fire-crackle.mp3', true, 0.2);

            uiController.updateHUD();
            uiController.showScreen('gameScreen');
            
            setTimeout(() => {
                this.loadNextQuestion();
            }, 100);
        }

        loadNextQuestion() {
            if (!gameState.isGameActive) return;

            this.isQuestionActive = true;
            
            if (this.questionPool.length === 0) {
                this.questionPool = [...QUESTIONS_DB[gameState.lang]];
            }

            const randomIndex = Math.floor(Math.random() * this.questionPool.length);
            const rawSentence = this.questionPool[randomIndex];
            this.questionPool.splice(randomIndex, 1);

            gameState.currentQ = {
                original: rawSentence,
                words: rawSentence.split(' ')
            };

            const ghosts = TRANSLATIONS[gameState.lang].ghost;
            const randomLine = ghosts[Math.floor(Math.random() * ghosts.length)];
            uiController.typewriter(randomLine, document.getElementById('ghostText'));
            audio.play('ghost-appear.mp3');

            const preview = document.getElementById('sentencePreview');
            preview.textContent = rawSentence;
            preview.style.opacity = '1';

            uiController.dropZone.innerHTML = '';
            uiController.wordPool.innerHTML = '';
            document.getElementById('submitBtn').disabled = true;

            setTimeout(() => {
                preview.style.opacity = '0';
                this.renderTiles(gameState.currentQ.words);
            }, 3000);
        }

        renderTiles(words) {
            uiController.wordPool.innerHTML = '';
            
            const shuffled = [...words].sort(() => Math.random() - 0.5);
            
            shuffled.forEach(word => {
                const tile = document.createElement('div');
                tile.className = 'word-tile';
                tile.textContent = word;
                tile.dataset.word = word;
                
                const handleTileClick = () => {
                    if (!this.isQuestionActive) return;
                    
                    audio.play('button-click.mp3');
                    
                    if (tile.parentElement.id === 'wordPool') {
                        uiController.dropZone.appendChild(tile);
                    } else {
                        uiController.wordPool.appendChild(tile);
                    }
                    
                    document.getElementById('submitBtn').disabled = uiController.dropZone.children.length === 0;
                };
                
                tile.addEventListener('click', handleTileClick);
                tile.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    handleTileClick();
                });
                
                uiController.wordPool.appendChild(tile);
            });
        }

        checkAnswer() {
            if (!this.isQuestionActive) return;
            
            const userWords = Array.from(uiController.dropZone.children).map(tile => tile.textContent);
            const userSentence = userWords.join(' ');
            
            const isCorrect = userSentence.trim() === gameState.currentQ.original.trim();

            this.isQuestionActive = false;
            
            document.querySelectorAll('.word-tile').forEach(tile => {
                tile.classList.add('disabled');
                tile.style.pointerEvents = 'none';
            });
            
            document.getElementById('submitBtn').disabled = true;

            if (isCorrect) {
                this.handleCorrect();
            } else {
                this.handleWrong();
            }

            if (gameState.ghostHP <= 0) {
                this.endGame(true);
            } else if (gameState.playerHP <= 0) {
                this.endGame(false);
            } else {
                setTimeout(() => this.loadNextQuestion(), 2000);
            }
        }

        handleCorrect() {
            audio.play('correct-answer.mp3');
            audio.play('ghost-hit.mp3');
            
            uiController.showHitEffect();
            document.getElementById('ghostChar').classList.add('shake-anim');
            setTimeout(() => document.getElementById('ghostChar').classList.remove('shake-anim'), 400);

            gameState.ghostHP = Math.max(0, gameState.ghostHP - CONFIG.DAMAGE_GHOST);
            gameState.xp += CONFIG.XP_PER_WIN;
            gameState.streak++;
            gameState.questionsAnswered++;
            if (gameState.streak > gameState.highStreak) gameState.highStreak = gameState.streak;

            uiController.updateHUD();
        }

        handleWrong() {
            audio.play('wrong-answer.mp3');
            audio.play('player-hit.mp3');
            
            uiController.shakeScreen();
            uiController.flashDamage();

            gameState.playerHP = Math.max(0, gameState.playerHP - CONFIG.DAMAGE_PLAYER);
            gameState.streak = 0;
            uiController.updateHUD();
        }

        endGame(isVictory) {
            gameState.isGameActive = false;
            this.isQuestionActive = false;
            audio.stopBGM();
            
            const prefix = isVictory ? 'vic' : 'def';
            const t = TRANSLATIONS[gameState.lang];
            
            document.getElementById(`${prefix}QValue`).textContent = `${gameState.questionsAnswered}`;
            document.getElementById(`${prefix}XPValue`).textContent = gameState.xp;
            document.getElementById(`${prefix}StrValue`).textContent = gameState.highStreak;

            if (isVictory) {
                audio.play('victory.mp3');
                uiController.showScreen('victoryScreen');
            } else {
                audio.play('defeat.mp3');
                uiController.showScreen('defeatScreen');
            }
        }

        async shareToWhatsApp(event) {
            const btn = event.target; 
            const originalText = btn.textContent;
            btn.textContent = "‚è≥ Uploading...";
            btn.disabled = true;

            document.getElementById('certName').textContent = gameState.name;
            document.getElementById('certXP').textContent = gameState.xp;
            document.getElementById('certStreak').textContent = gameState.highStreak;

            try {
                const canvas = await html2canvas(document.getElementById('certificateNode'), {
                    useCORS: true,
                    allowTaint: false,
                    backgroundColor: null,
                    scale: uiController.isMobile ? 1 : 1.5,
                    logging: false,
                    onclone: (clonedDoc) => {
                        const style = clonedDoc.createElement('style');
                        style.textContent = `
                            @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Philosopher:wght@400;700&family=Rajdhani:wght@500;700&display=swap');
                        `;
                        clonedDoc.head.appendChild(style);
                    }
                });
                
                canvas.toBlob(async (blob) => {
                    if (!blob) throw new Error("Image generation failed");

                    const timestamp = Date.now();
                    const filename = `cert_${gameState.name.replace(/[^a-z0-9]/gi, '_')}_${timestamp}.png`;

                    let imageUrl = "";
                    let dbSuccess = false;
                    let errorMessage = "";
                    
                    try {
                        console.log("Starting Supabase upload process...");
                        
                        const { data: uploadData, error: uploadError } = await supabase
                            .storage
                            .from('certificates')
                            .upload(filename, blob, {
                                cacheControl: '3600',
                                upsert: false
                            });

                        if (uploadError) {
                            console.error("‚ùå Storage upload error:", uploadError);
                            errorMessage = `Storage upload failed: ${uploadError.message}`;
                            throw new Error(errorMessage);
                        }

                        console.log("‚úÖ Storage upload successful:", uploadData);

                        const { data: publicUrlData } = supabase
                            .storage
                            .from('certificates')
                            .getPublicUrl(filename);
                        
                        imageUrl = publicUrlData.publicUrl;
                        console.log("‚úÖ Public URL obtained:", imageUrl);

                        const { data: dbData, error: dbError } = await supabase
                            .from('leaderboard')
                            .insert([{ 
                                player_name: gameState.name, 
                                xp: gameState.xp, 
                                streak: gameState.highStreak,
                                image_url: imageUrl,
                                created_at: new Date().toISOString()
                            }])
                            .select();

                        if (dbError) {
                            console.error("‚ùå Database insert error:", dbError);
                            errorMessage = `Database insert failed: ${dbError.message}`;
                            
                            const { error: altError } = await supabase
                                .from('scores')
                                .insert([{ 
                                    player_name: gameState.name, 
                                    xp: gameState.xp, 
                                    streak: gameState.highStreak,
                                    image_url: imageUrl,
                                    created_at: new Date().toISOString()
                                }]);
                            
                            if (altError) {
                                console.error("‚ùå Alternative table also failed:", altError);
                                throw new Error(errorMessage);
                            }
                            
                            console.log("‚úÖ Saved to alternative 'scores' table");
                            dbSuccess = true;
                        } else {
                            console.log("‚úÖ Database insert success:", dbData);
                            dbSuccess = true;
                        }

                    } catch (storageError) {
                        console.warn("‚ö†Ô∏è Supabase storage failed, falling back to localStorage:", storageError);
                        
                        const localData = {
                            player_name: gameState.name,
                            xp: gameState.xp,
                            streak: gameState.highStreak,
                            timestamp: Date.now()
                        };
                        
                        const reader = new FileReader();
                        reader.onloadend = function() {
                            localData.certificate = reader.result;
                            const saves = JSON.parse(localStorage.getItem('dungeonSpellerSaves') || '[]');
                            saves.push(localData);
                            localStorage.setItem('dungeonSpellerSaves', JSON.stringify(saves));
                            console.log("‚úÖ Saved locally:", localData);
                        };
                        reader.readAsDataURL(blob);
                        
                        dbSuccess = true;
                        imageUrl = "Saved locally";
                        errorMessage = storageError.message;
                    }

                    if (dbSuccess) {
                        btn.textContent = "‚úÖ Saved!";
                        alert(`Game results saved successfully!\n\nPlayer: ${gameState.name}\nXP: ${gameState.xp}\nBest Streak: ${gameState.highStreak}\n\n${imageUrl}`);
                    } else {
                        btn.textContent = "‚ö†Ô∏è Partial Save";
                        alert("Results saved locally but cloud sync failed.\n\nError: " + errorMessage);
                    }
                    
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }, 3000);

                }, 'image/png', 0.9);

            } catch (err) {
                console.error("‚ùå Critical error in shareToWhatsApp:", err);
                alert("Error saving results: " + err.message + "\n\nCheck browser console (F12) for details.");
                btn.textContent = "‚ùå Error";
                btn.disabled = false;
            }
        }

        restartGame() {
            this.startGame();
        }
    }
    
    // --- 5. STARTUP ---
    if (!window.gameController) {
        window.gameController = new GameController();
    }
    
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                document.body.style.overflow = '';
            }, 50);
        }, 250);
    });
    
    document.addEventListener('touchstart', (e) => {
        if (e.touches.length > 1) {
            e.preventDefault();
        }
    }, { passive: false });
    
    window.addEventListener('orientationchange', () => {
        setTimeout(() => {
            window.scrollTo(0, 0);
        }, 100);
    });
</script>
</body>
</html>
